<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ramallah Waste Containers - Density Colored with Zone Info</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { margin: 0; height: 100%; width: 100%; }
    #map { position: absolute; width: 100%; height: 100%; }
    .info, .legend {
      background: rgba(255,255,255,0.8);
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      border-radius: 5px;
    }
    .legend i {
      width: 18px; height: 18px;
      float: right; margin-left: 8px; opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    const map = L.map("map", { center: [31.9045, 35.2045], zoom: 15 });

    const baseLayers = {
      "خريطة داكنة": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO' }),
      "خريطة الشوارع": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }),
      "أقمار صناعية": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri & OpenStreetMap contributors' })
    };
    baseLayers["خريطة داكنة"].addTo(map);

    let zonesLayer, wasteContainersLayer, containerData, zoneDensity = {};

    // تحميل المناطق أولاً
    $.getJSON("RamallahZones.json", function(RZ) {
      zonesLayer = L.geoJson(RZ, {
        style: { color: "black", weight: 1, fillOpacity: 0.05 }
      }).addTo(map);

      // بعد تحميل المناطق، نحمل النقاط
      $.getJSON("wasteContainer.json", function(WC) {
        containerData = WC;

        // حساب عدد الحاويات في كل منطقة
        zonesLayer.eachLayer(function(zoneLayer) {
          const zoneFeature = zoneLayer.feature;
          let count = 0;
          WC.features.forEach(f => {
            const p = turf.point([f.geometry.coordinates[0], f.geometry.coordinates[1]]);
            if (turf.booleanPointInPolygon(p, zoneFeature)) count++;
          });
          zoneDensity[zoneFeature.properties.NAME] = count;
        });

        // حساب الحدود الدنيا والعليا لتحديد الكثافة النسبية
        const counts = Object.values(zoneDensity);
        const max = Math.max(...counts);
        const min = Math.min(...counts);

        // دالة لتحديد اللون بناء على الكثافة
        function getDensityColor(zoneName) {
          const c = zoneDensity[zoneName] || 0;
          const ratio = (c - min) / (max - min + 0.001);
          if (ratio > 0.66) return "red";
          else if (ratio > 0.33) return "yellow";
          else return "green";
        }

        // رسم النقاط بالألوان حسب كثافة منطقتها
        wasteContainersLayer = L.geoJson(WC, {
          pointToLayer: function(feature, latlng) {
            let zoneName = "خارج المناطق";
            zonesLayer.eachLayer(function(z) {
              const p = turf.point([latlng.lng, latlng.lat]);
              if (turf.booleanPointInPolygon(p, z.feature)) zoneName = z.feature.properties.NAME;
            });
            const color = getDensityColor(zoneName);
            return L.circleMarker(latlng, {
              radius: 6,
              fillColor: color,
              color: "white",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).bindPopup(`<b>نوع الحاوية:</b> ${feature.properties.TYPE_OF_WA || "غير محدد"}<br>
                          <b>المنطقة:</b> ${zoneName}<br>
                          <b>عدد الحاويات في المنطقة:</b> ${zoneDensity[zoneName] || 0}`);
          }
        }).addTo(map);

        // عند النقر على منطقة، عرض عدد الحاويات واسم المنطقة
        zonesLayer.eachLayer(function(layer) {
          const zoneName = layer.feature.properties.NAME;
          const count = zoneDensity[zoneName] || 0;
          layer.on('click', function(e) {
            layer.bindPopup(`<b>المنطقة:</b> ${zoneName}<br><b>عدد الحاويات:</b> ${count}`).openPopup();
          });
        });

        // إضافة وسيلة الإيضاح (Legend)
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML += "<b>تصنيف الكثافة:</b><br>";
          div.innerHTML += '<i style="background:red"></i> كثافة عالية<br>';
          div.innerHTML += '<i style="background:yellow"></i> كثافة متوسطة<br>';
          div.innerHTML += '<i style="background:green"></i> كثافة منخفضة<br>';
          return div;
        };
        legend.addTo(map);
      });
    });

    // عرض الإحداثيات عند تحريك الماوس
    const info = L.control({ position: 'bottomleft' });
    info.onAdd = function() {
      this._div = L.DomUtil.create('div', 'info');
      this.update();
      return this._div;
    };
    info.update = function(latlng) {
      this._div.innerHTML = latlng
        ? `<b>Lat:</b> ${latlng.lat.toFixed(5)} , <b>Lng:</b> ${latlng.lng.toFixed(5)}`

