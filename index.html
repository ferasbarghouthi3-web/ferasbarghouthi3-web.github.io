<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ School Planning DSS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}

.dashboard {
  position:absolute;
  bottom:20px;
  right:20px;
  background:white;
  padding:10px;
  z-index:1000;
  font-size:13px;
}

/* Legend */
.legend {
  background:white;
  padding:8px;
  font-size:12px;
  line-height:18px;
}
.legend span {
  display:inline-block;
  width:14px;
  height:14px;
  margin-right:5px;
}
</style>
</head>

<body>

<div class="header">
<h3>Decision Support System Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<div class="dashboard">
<b>ğŸ“Š Dashboard</b><br>
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª: <span id="tTotal">0</span><br>
ØªØ¬Ù…Ø¹Ø§Øª ØªØ¹Ø§Ù†ÙŠ Ù…Ù† Ù†Ù‚Øµ: <span id="tDef">0</span><br>
Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©: <span id="tSites">0</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
const map = L.map("map").setView([31.9,35.2],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= LOAD DATA =================
Promise.all([
 fetch("tg.json").then(r=>r.json()),
 fetch("schools.json").then(r=>r.json()),
 fetch("roads.json").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json()),
 fetch("settlements.geojson").then(r=>r.json()),
 fetch("outposts.geojson").then(r=>r.json()),
 fetch("military.geojson").then(r=>r.json()),
 fetch("wadis.geojson").then(r=>r.json()),
 fetch("quarries.geojson").then(r=>r.json()),
 fetch("natural.geojson").then(r=>r.json()),
 fetch("wells.geojson").then(r=>r.json()),
 fetch("clinics.geojson").then(r=>r.json()),
 fetch("hospitals.geojson").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(d){

let [
 tg, schools, roads, built,
 sett, outp, mil, wad,
 qua, nat, wells, clin, hosp
] = d;

let deficitCount = 0;
let siteCount = 0;

// ================= LAYERS =================
const builtL = L.geoJSON(built,{style:{color:"#999",fillOpacity:0.3}});
const roadsL = L.geoJSON(roads,{style:{color:"orange"}});
const settL  = L.geoJSON(sett,{style:{color:"red",fillOpacity:0.4}});
const outpL  = L.geoJSON(outp,{style:{color:"darkred"}});
const milL   = L.geoJSON(mil,{style:{color:"black"}});
const wadL   = L.geoJSON(wad,{style:{color:"blue"}});
const quaL   = L.geoJSON(qua,{style:{color:"brown"}});
const natL   = L.geoJSON(nat,{style:{color:"green",fillOpacity:0.3}});

const wellsL = L.geoJSON(wells,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:4,color:"purple"})});
const clinL  = L.geoJSON(clin,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:4,color:"teal"})});
const hospL  = L.geoJSON(hosp,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:4,color:"black"})});

const schoolsL = L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue"})
});

// ================= TG ANALYSIS =================
const tgLayer = L.geoJSON(tg,{
 style:f=>{
  const pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
  const need=Math.ceil(pop/3000);
  const cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
  return {
   color:"black",
   fillColor: cnt<need?"red":"green",
   fillOpacity:0.4
  };
 },
 onEachFeature:(f,l)=>{
  const pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
  const need=Math.ceil(pop/3000);
  const cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
  const deficit=cnt<need;

  if(deficit){
   deficitCount++;
   const c=turf.centroid(f);
   L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
    .addTo(map)
    .bindPopup("Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­");
   siteCount++;
  }

  l.bindPopup(`
   <b>${f.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
   Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${cnt}<br>
   Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${need}<br>
   Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit?"Ù†Ù‚Øµ":"Ù…ÙƒØªÙÙŠ"}
  `);
 }
});

// ================= ADD TO MAP =================
[builtL,roadsL,settL,outpL,milL,wadL,quaL,natL,
 wellsL,clinL,hospL,schoolsL,tgLayer].forEach(l=>l.addTo(map));

// ================= LAYER CONTROL =================
L.control.layers(null,{
 "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª":tgLayer,
 "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³":schoolsL,
 "Ø§Ù„Ø·Ø±Ù‚":roadsL,
 "Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¨Ù†ÙŠØ©":builtL,
 "Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª":settL,
 "Ø§Ù„Ø¨Ø¤Ø± Ø§Ù„Ø§Ø³ØªÙŠØ·Ø§Ù†ÙŠØ©":outpL,
 "Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ©":milL,
 "Ø§Ù„Ø£ÙˆØ¯ÙŠØ©":wadL,
 "Ø§Ù„ÙƒØ³Ø§Ø±Ø§Øª":quaL,
 "Ø§Ù„Ù…Ø­Ù…ÙŠØ§Øª":natL,
 "Ø§Ù„Ø¢Ø¨Ø§Ø±":wellsL,
 "Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª":clinL,
 "Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª":hospL
}).addTo(map);

// ================= LEGEND =================
const legend = L.control({position:"bottomleft"});
legend.onAdd = ()=>{
 const div=L.DomUtil.create("div","legend");
 div.innerHTML=`
 <b>Legend</b><br>
 <span style="background:red"></span> Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³<br>
 <span style="background:green"></span> Ù…ÙƒØªÙÙŠ
 `;
 return div;
};
legend.addTo(map);

// ================= DASHBOARD =================
document.getElementById("tTotal").innerText=tg.features.length;
document.getElementById("tDef").innerText=deficitCount;
document.getElementById("tSites").innerText=siteCount;

map.fitBounds(tgLayer.getBounds());
}
</script>

</body>
</html>

