<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Web GIS - Ramallah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    html,body{height:100%;margin:0;}
    #map{height:100%;width:100%;}
    .icon{
      width:10px;height:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      font-weight:bold;
      border-radius:50%;
    }
    /* LANDMARK COLORS */
    .icon-school{background:#1e90ff;}
    .icon-hospital{background:#b22222;}
    .icon-clinic{background:#2e8b57;}
    .icon-well{background:#00ced1;}
    .icon-quarry{background:#696969;}
    .icon-outpost{background:#ff8c00;}
    
    /* LEGEND */
    .legend{
      background:white;
      padding:10px;
      font-size:13px;
      border-radius:6px;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    /* POPUP */
    .popup-table{border-collapse:collapse;width:100%;}
    .popup-table td{border-bottom:1px solid #ddd;padding:4px;font-size:12px;}
    .popup-title{font-weight:bold;margin-bottom:6px;}
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    /* MAP */
    var map = L.map("map").setView([31.9038,35.2034],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      attribution:"&copy; OpenStreetMap"
    }).addTo(map);

    /* POPUP FUNCTION (with Arabic Labels) */
    function popupAttributes(feature, layer){
      if(!feature.properties) return;
      let html='<div class="popup-title">الخصائص</div><table class="popup-table">';
      for(let k in feature.properties){
        html+=`<tr><td><b>${k}</b></td><td>${feature.properties[k]}</td></tr>`;
      }
      html+='</table>';
      layer.bindPopup(html);
    }

    /* ICON */
    function icon(cls){
      return L.divIcon({
        className:"",
        html:`<div class="icon ${cls}"></div>`,
        iconSize:[10,10],
        iconAnchor:[5,5]
      });
    }

    /* LOAD DATA */
    Promise.all([
      fetch("ramallah.json").then(r=>r.json()),
      fetch("schools.json").then(r=>r.json()),
      fetch("roods.json").then(r=>r.json()),
      fetch("Built_up.json").then(r=>r.json()),
      fetch("Settlements.geojson").then(r=>r.json()),
      fetch("Outposts.geojson").then(r=>r.json()),
      fetch("Military sites.geojson").then(r=>r.json()),
      fetch("Quarries.geojson").then(r=>r.json()),
      fetch("natural.json").then(r=>r.json()),
      fetch("Wells.geojson").then(r=>r.json()),
      fetch("Clinics.geojson").then(r=>r.json()),
      fetch("Hospitals.geojson").then(r=>r.json()),
      fetch("area_A.geojson").then(r=>r.json()),
      fetch("Area_B.geojson").then(r=>r.json()),
      fetch("area_C.geojson").then(r=>r.json())
    ]).then(initLayers);

    /* LAYERS */
    function initLayers(data){
      let [ramallah, schools, roads, built, settlements, outposts, military, quarries, natural, wells, clinics, hospitals, areaA, areaB, areaC] = data;

      /* RAMALLAH BORDER */
      var ramallahLayer=L.geoJSON(ramallah, {
        style:{color:"#000",weight:4,fillOpacity:0},
        onEachFeature:popupAttributes
      }).addTo(map);

      /* LAND CLASSIFICATION */
      var areaALayer=L.geoJSON(areaA,{style:{color:"#006400",weight:2,fillColor:"#00ff00",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);
      var areaBLayer=L.geoJSON(areaB,{style:{color:"#b8860b",weight:2,fillColor:"#ffff00",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);
      var areaCLayer=L.geoJSON(areaC,{style:{color:"#8b0000",weight:2,fillColor:"#ff0000",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);

      /* BASE */
      var builtLayer=L.geoJSON(built,{style:{color:"#8B4513",weight:2,fillColor:"#F5F5DC",fillOpacity:0.7},onEachFeature:popupAttributes}).addTo(map);
      var roadsLayer=L.geoJSON(roads,{style:{color:"#4B0082",weight:2},onEachFeature:popupAttributes}).addTo(map);

      /* POINTS */
      var schoolsLayer=L.geoJSON(schools,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-school")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var hospitalsLayer=L.geoJSON(hospitals,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-hospital")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var clinicsLayer=L.geoJSON(clinics,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-clinic")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var wellsLayer=L.geoJSON(wells,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-well")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var quarriesLayer=L.geoJSON(quarries,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-quarry")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var outpostsLayer=L.geoJSON(outposts,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-outpost")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      /* POLYGONS */
      var settlementsLayer=L.geoJSON(settlements,{style:{color:"#ff0000",weight:2},onEachFeature:popupAttributes}).addTo(map);
      var militaryLayer=L.geoJSON(military,{style:{color:"#800000",weight:2},onEachFeature:popupAttributes}).addTo(map);
      var naturalLayer=L.geoJSON(natural,{style:{color:"#228b22",fillOpacity:0.5},onEachFeature:popupAttributes}).addTo(map);

      /* SUGGESTED SCHOOLS LAYER */
      var suggestedSchools = {
        "type": "FeatureCollection",
        "features": []
      };

      /* Simple spatial logic for suggestions */
      built.eachLayer(function(builtFeature){
        var center = builtFeature.getBounds().getCenter();
        var schoolCount = 0;

        schoolsLayer.eachLayer(function(school){
          if (builtFeature.getBounds().contains(school.getLatLng())) {
            schoolCount++;
          }
        });

        // Threshold (منطقي وبسيط)
        if (schoolCount < 2) {
          suggestedSchools.features.push({
            "type": "Feature",
            "properties": {
              "status": "مقترح",
              "reason": "عدد مدارس منخفض بالنسبة للتجمع"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [center.lng, center.lat]
            }
          });
        }
      });

      /* ADD SUGGESTED SCHOOLS LAYER */
      var suggestedSchoolsLayer = L.geoJSON(suggestedSchools,{
        pointToLayer:(f,ll)=>L.circleMarker(ll,{
          radius:7,
          color:"#000",
          fillColor:"#ff1493",
          fillOpacity:0.8,
          weight:2
        }),
        onEachFeature:function(feature,layer){
          layer.bindPopup(
            `<b>مدرسة مقترحة</b><br>
             الحالة: ${feature.properties.status}<br>
             السبب: ${feature.properties.reason}`
          );
        }
      }).addTo(map);

      /* ORDER */
      areaALayer.bringToBack();
      areaBLayer.bringToBack();
      areaCLayer.bringToBack();
      ramallahLayer.bringToFront();

      /* LAYER CONTROL */
      L.control.layers(null,{
        "Ramallah Boundary":ramallahLayer,
        "Area A":areaALayer,
        "Area B":areaBLayer,
        "Area C":areaCLayer,
        "Built-up Areas":builtLayer,
        "Roads":roadsLayer,
        "Schools":schoolsLayer,
        "Hospitals":hospitalsLayer,
        "Clinics":clinicsLayer,
        "Wells":wellsLayer,
        "Quarries":quarriesLayer,
        "Outposts":outpostsLayer,
        "Settlements":settlementsLayer,
        "Military Sites":militaryLayer,
        "Natural Areas":naturalLayer,
        "Suggested Schools": suggestedSchoolsLayer
      },{
        collapsed:false
      }).addTo(map);

      /* LEGEND */
      var legend=L.control({position:"bottomright"});
      legend.onAdd=function(){
        var div=L.DomUtil.create("div","legend");
        div.innerHTML=`
          <b>Legend</b>
          <div class="legend-item"><div style="width:14px;height:14px;background:#00ff00;border:2px solid #006400"></div>Area A</div>
          <div class="legend-item"><div style="width:14px;height:14px;background:#ffff00;border:2px solid #b8860b"></div>Area B</div>
          <div class="legend-item"><div style="width:14px;height:14px;background:#ff0000;border:2px solid #8b0000"></div>Area C</div>
          <hr>
          <div class="legend-item"><div class="icon icon-school"></div>Schools</div>
          <div class="legend-item"><div class="icon icon-hospital"></div>Hospitals</div>
          <div class="legend-item"><div class="icon icon-clinic"></div>Clinics</div>
          <div class="legend-item"><div class="icon icon-well"></div>Wells</div>
          <div class="legend-item"><div class="icon icon-quarry"></div>Quarries</div>
          <div class="legend-item"><div class="icon icon-outpost"></div>Outposts</div>
        `;
        return div;
      };
      legend.addTo(map);

    }
  </script>
</body>
</html>
