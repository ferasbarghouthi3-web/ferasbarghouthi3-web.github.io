<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ School Planning DSS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}

.dashboard {
  position:absolute;
  bottom:20px;
  right:20px;
  background:white;
  padding:10px;
  z-index:1000;
  font-size:13px;
}
</style>
</head>

<body>

<div class="header">
<h3>Decision Support System Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<div class="dashboard">
<b>ğŸ“Š Dashboard</b><br>
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª: <span id="tTotal">0</span><br>
ØªØ¬Ù…Ø¹Ø§Øª ØªØ¹Ø§Ù†ÙŠ Ù…Ù† Ù†Ù‚Øµ: <span id="tDef">0</span><br>
Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©: <span id="tSites">0</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9,35.2],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// Pane Ù„Ù„ØªØ¬Ù…Ø¹Ø§Øª (ØªØ­Øª)
map.createPane("tgPane");
map.getPane("tgPane").style.zIndex = 200;

// ================= LOAD DATA =================
Promise.all([
 fetch("tgmooat.json").then(r=>r.json()),
 fetch("Ramallah_Schools.json").then(r=>r.json()),
 fetch("roads.json").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json()),
 fetch("settlements.geojson").then(r=>r.json()),
 fetch("outposts.geojson").then(r=>r.json()),
 fetch("military.geojson").then(r=>r.json()),
 fetch("wadis.geojson").then(r=>r.json()),
 fetch("quarries.geojson").then(r=>r.json()),
 fetch("natural.json").then(r=>r.json()),
 fetch("Wells.geojson").then(r=>r.json()),
 fetch("clinics.geojson").then(r=>r.json()),
 fetch("hospitals.geojson").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(d){

let [tg,schools,roads,built,sett,outp,mil,wad,qua,nat,wells,clin,hosp] = d;

let deficitCount=0, siteCount=0;

// ===== DISPLAY ALL LAYERS =====
L.geoJSON(built,{style:{color:"#999",fillOpacity:0.3}}).addTo(map);
L.geoJSON(roads,{style:{color:"orange"}}).addTo(map);
L.geoJSON(sett,{style:{color:"red",fillOpacity:0.4}}).addTo(map);
L.geoJSON(outp,{style:{color:"darkred"}}).addTo(map);
L.geoJSON(mil,{style:{color:"black"}}).addTo(map);
L.geoJSON(wad,{style:{color:"blue"}}).addTo(map);
L.geoJSON(qua,{style:{color:"brown"}}).addTo(map);
L.geoJSON(nat,{style:{color:"green"}}).addTo(map);

[wells,clin,hosp].forEach(g=>{
 L.geoJSON(g,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:4})}).addTo(map);
});

L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue"})
}).addTo(map);

// ===== SEARCH =====
L.Control.geocoder({defaultMarkGeocode:false})
.on("markgeocode",e=>map.fitBounds(e.geocode.bbox))
.addTo(map);

// ===== MAIN ANALYSIS =====
let tgLayer = L.geoJSON(tg,{
 pane:"tgPane",
 style:f=>{
   let pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
   let need=Math.ceil(pop/3000);
   let cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
   let diff=need-cnt;
   let c= diff>=2?"red": diff==1?"orange":"green";
   return {color:"black",fillOpacity:0.3,fillColor:c};
 },
 onEachFeature:(f,l)=>{
   let pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
   let need=Math.ceil(pop/3000);
   let cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
   let deficit=cnt<need;
   if(deficit) deficitCount++;

   let html=`<b>${f.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
   Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${cnt}<br>
   Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${need}<br>
   Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit?"Ù†Ù‚Øµ":"Ù…ÙƒØªÙÙŠ"}`;

   if(deficit){
     let c=turf.centroid(f);
     let farSet=[sett,outp].every(g=>g.features.every(s=>turf.distance(c,s,{units:"km"})>0.8));
     let safe=[mil,wad,qua,nat].every(g=>g.features.every(x=>!turf.booleanPointInPolygon(c,x)));
     let insideBuilt=turf.booleanPointInPolygon(c,built);
     let nearRoad=roads.features.some(r=>turf.distance(c,r,{units:"km"})<0.5);
     let nearServ=[wells,clin,hosp].some(g=>g.features.some(x=>turf.distance(c,x,{units:"km"})<1));

     let score=(insideBuilt?25:0)+(nearRoad?20:0)+(farSet?25:0)+(safe?20:0)+(nearServ?10:0);
     let price=100+(insideBuilt?30:0)+(nearRoad?20:0)+(nearServ?20:0)+(score>=70?20:0)-(farSet?0:50);

     L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
      .addTo(map)
      .bindPopup(Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­<br>Score: ${score}/100<br>Ø§Ù„Ø³Ø¹Ø±: ${price}$);
     siteCount++;

     html+=<hr>Score: ${score}/100<br>Ø§Ù„Ø³Ø¹Ø±: ${price}$;
   }
   l.bindPopup(html);
 }
}).addTo(map);

// ===== DASHBOARD =====
document.getElementById("tTotal").innerText=tg.features.length;
document.getElementById("tDef").innerText=deficitCount;
document.getElementById("tSites").innerText=siteCount;

map.fitBounds(tgLayer.getBounds());
}
</script>
</body>
</html>
