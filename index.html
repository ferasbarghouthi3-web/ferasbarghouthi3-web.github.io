<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Ramallah Web Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
    body { margin:0; padding:0; }
    #map { width:100%; height:100vh; }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// =====================================================
// 1) MAP INITIALIZATION
// =====================================================
var map = L.map("map").setView([31.9, 35.2], 13);

L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom: 19 }
).addTo(map);

// =====================================================
// 1.1) PANES (للتحكم بالترتيب)
// =====================================================
map.createPane("builtupPane");
map.getPane("builtupPane").style.zIndex = 400;

map.createPane("wadiPane");
map.getPane("wadiPane").style.zIndex = 450; // فوق البيلت أب

// =====================================================
// 2) GEOJSON LOADER
// =====================================================
function loadGeoJSON(file, options = {}) {

    return fetch(file)
    .then(res => {
        if (!res.ok) throw new Error(file + " not found");
        return res.json();
    })
    .then(data => {

        return L.geoJSON(data, {
            pane: options.pane,
            style: function(feature){
                if (feature.geometry.type !== "Point" && options.style) {
                    return options.style;
                }
            },
            pointToLayer: function(feature, latlng){
                return L.marker(latlng);
            },
            onEachFeature: function(feature, layer){
                let html = "<table>";
                for (let k in feature.properties){
                    html += `
                    <tr>
                        <td><b>${k}</b></td>
                        <td>${feature.properties[k]}</td>
                    </tr>`;
                }
                html += "</table>";
                layer.bindPopup(html);
            }
        });

    })
    .catch(err => {
        console.warn(err.message);
        return L.layerGroup();
    });
}

// =====================================================
// 3) LOAD ALL LAYERS (OLD + NEW)
// =====================================================
Promise.all([

    // الطبقات القديمة
    loadGeoJSON("ramallah.json", {
        style:{ color:"#000", weight:3, fillOpacity:0 }
    }),

    loadGeoJSON("built_up.json", {
        pane: "builtupPane",
        style:{ color:"#ff7800", weight:1, fillOpacity:0.6 }
    }),

    loadGeoJSON("roods.json", {
        style:{ color:"#0066ff", weight:2 }
    }),

    loadGeoJSON("natural.json", {
        style:{ color:"#2e8b57", fillOpacity:0.4 }
    }),

    loadGeoJSON("schools.json"),

    // الطبقات الجديدة
    loadGeoJSON("Wells.geojson"),
    
    // الأودية (مهمة)
    loadGeoJSON("الودية.geojson", {
        pane: "wadiPane",
        style:{
            color:"#0000ff",
            weight:3,
            opacity:1
        }
    }),

    loadGeoJSON("البؤر_الاستيطانية.geojson"),
    loadGeoJSON("العيادات.geojson"),
    loadGeoJSON("المواقع_العسكرية.geojson"),
    loadGeoJSON("كسارات.geojson"),
    loadGeoJSON("مستوطنات.geojson")

]).then(function(layers){

    var overlays = {
        "Ramallah Boundary": layers[0].addTo(map),
        "Built-up Areas": layers[1].addTo(map),
        "Road Network": layers[2].addTo(map),
        "Natural Areas": layers[3].addTo(map),
        "Schools": layers[4].addTo(map),

        // الجديدة
        "Wells": layers[5],
        "الأودية": layers[6].addTo(map), // ⬅️ تظهر افتراضياً
        "البؤر الاستيطانية": layers[7],
        "العيادات": layers[8],
        "المواقع العسكرية": layers[9],
        "كسارات": layers[10],
        "مستوطنات": layers[11]
    };

    L.control.layers(null, overlays).addTo(map);

    // Zoom to Ramallah boundary
    map.fitBounds(layers[0].getBounds());
});
</script>

</body>
</html>
