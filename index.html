<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WebGIS ‚Äì School Site Selection (Ramallah)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0;}
#map{height:100%;width:100%;}

/* ICONS */
.icon{
  width:18px;height:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  font-weight:bold;
  border:2px solid #000;
}
.icon-school{background:#1e90ff;color:#fff;border-radius:4px;}
.icon-hospital{background:#b22222;color:#fff;border-radius:50%;}
.icon-clinic{background:#2e8b57;color:#fff;border-radius:50%;}
.icon-proposed{background:#800080;color:#fff;border-radius:50%;}

/* LEGEND */
.legend{
  background:white;
  padding:10px;
  font-size:12px;
  border-radius:6px;
  box-shadow:0 0 10px rgba(0,0,0,0.3);
}
.legend-item{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>

/* MAP */
var map = L.map("map").setView([31.9038,35.2034],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OSM"}).addTo(map);

/* ICON FACTORY */
function icon(symbol, cls){
  return L.divIcon({
    className:"",
    html:`<div class="icon ${cls}">${symbol}</div>`,
    iconSize:[18,18],
    iconAnchor:[9,9]
  });
}

/* LOAD DATA */
Promise.all([
  fetch("schools.json").then(r=>r.json()),
  fetch("Hospitals.geojson").then(r=>r.json()),
  fetch("Clinics.geojson").then(r=>r.json()),
  fetch("Settlements.geojson").then(r=>r.json()),
  fetch("Outposts.geojson").then(r=>r.json()),
  fetch("Military sites.geojson").then(r=>r.json()),
  fetch("Quarries.geojson").then(r=>r.json()),
  fetch("natural.json").then(r=>r.json()),
  fetch("area_A.geojson").then(r=>r.json()),
  fetch("Area_B.geojson").then(r=>r.json())
]).then(init);

/* INIT */
function init(data){

let [
  schools,hospitals,clinics,
  settlements,outposts,military,quarries,natural,
  areaA,areaB
] = data;

/* DISPLAY BASIC LAYERS */
L.geoJSON(schools,{pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("üéì","icon-school")})}).addTo(map);
L.geoJSON(hospitals,{pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("+","icon-hospital")})}).addTo(map);
L.geoJSON(clinics,{pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("+","icon-clinic")})}).addTo(map);

/* BUFFER ZONES (meters) */
let dangerBuffer = turf.buffer(
  turf.featureCollection([
    ...settlements.features,
    ...outposts.features,
    ...military.features,
    ...quarries.features
  ]), 500, {units:"meters"}
);

let naturalBuffer = turf.buffer(
  turf.featureCollection(natural.features),
  300, {units:"meters"}
);

/* MERGE ALLOWED AREAS A + B */
let allowedArea = turf.union(
  turf.featureCollection(areaA.features),
  turf.featureCollection(areaB.features)
);

/* GENERATE RANDOM CANDIDATE POINTS */
let candidates = turf.randomPoint(30, {bbox:turf.bbox(allowedArea)});

/* FILTER SUITABLE SITES */
let suitable = {
  type:"FeatureCollection",
  features:[]
};

candidates.features.forEach(pt=>{
  if(
    turf.booleanPointInPolygon(pt, allowedArea) &&
    !turf.booleanPointInPolygon(pt, dangerBuffer) &&
    !turf.booleanPointInPolygon(pt, naturalBuffer)
  ){
    let nearSchools = turf.pointsWithinDistance(pt, schools, 1, {units:"kilometers"});
    pt.properties = {
      nearby_schools: nearSchools.features.length,
      required_schools: Math.max(0, 3 - nearSchools.features.length),
      suitability: "High"
    };
    suitable.features.push(pt);
  }
});

/* DISPLAY PROPOSED SITES */
L.geoJSON(suitable,{
  pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("üè´","icon-proposed")}),
  onEachFeature:(f,l)=>{
    l.bindPopup(`
      <b>Proposed School Site</b><br>
      Nearby Schools: ${f.properties.nearby_schools}<br>
      Required Schools: ${f.properties.required_schools}<br>
      Suitability: <b>${f.properties.suitability}</b>
    `);
  }
}).addTo(map);

/* LEGEND */
var legend=L.control({position:"bottomright"});
legend.onAdd=function(){
  var d=L.DomUtil.create("div","legend");
  d.innerHTML=`
  <b>Legend</b>
  <div class="legend-item"><div class="icon icon-school">üéì</div> Existing Schools</div>
  <div class="legend-item"><div class="icon icon-proposed">üè´</div> Proposed Sites</div>
  <div class="legend-item"><div class="icon icon-hospital">+</div> Hospitals</div>
  <div class="legend-item"><div class="icon icon-clinic">+</div> Clinics</div>
  `;
  return d;
};
legend.addTo(map);

}
</script>
</body>
</html>
