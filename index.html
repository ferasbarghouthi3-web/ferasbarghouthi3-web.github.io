<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Web GIS - Ramallah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    html,body{height:100%;margin:0;}
    #map{height:100%;width:100%;}
    .icon{
      width:10px;height:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      font-weight:bold;
      border-radius:50%;
    }
    .icon-school{background:#1e90ff;}
    .icon-hospital{background:#b22222;}
    .icon-clinic{background:#2e8b57;}
    .icon-well{background:#00ced1;}
    .icon-quarry{background:#696969;}
    .icon-outpost{background:#ff8c00;}
    
    .legend{
      background:white;
      padding:10px;
      font-size:13px;
      border-radius:6px;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    .popup-table{border-collapse:collapse;width:100%;}
    .popup-table td{border-bottom:1px solid #ddd;padding:4px;font-size:12px;}
    .popup-title{font-weight:bold;margin-bottom:6px;}
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    var map = L.map("map").setView([31.9038,35.2034],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      attribution:"&copy; OpenStreetMap"
    }).addTo(map);

    function popupAttributes(feature, layer){
      if(!feature.properties) return;
      let html='<div class="popup-title">الخصائص</div><table class="popup-table">';
      for(let k in feature.properties){
        html+=`<tr><td><b>${k}</b></td><td>${feature.properties[k]}</td></tr>`;
      }
      html+='</table>';
      layer.bindPopup(html);
    }

    function icon(cls){
      return L.divIcon({
        className:"",
        html:`<div class="icon ${cls}"></div>`,
        iconSize:[10,10],
        iconAnchor:[5,5]
      });
    }

    Promise.all([
      fetch("ramallah.json").then(r=>r.json()),
      fetch("schools.json").then(r=>r.json()),
      fetch("roods.json").then(r=>r.json()),
      fetch("Built_up.json").then(r=>r.json()),
      fetch("Settlements.geojson").then(r=>r.json()),
      fetch("Outposts.geojson").then(r=>r.json()),
      fetch("Military sites.geojson").then(r=>r.json()),
      fetch("Quarries.geojson").then(r=>r.json()),
      fetch("natural.json").then(r=>r.json()),
      fetch("Wells.geojson").then(r=>r.json()),
      fetch("Clinics.geojson").then(r=>r.json()),
      fetch("Hospitals.geojson").then(r=>r.json()),
      fetch("area_A.geojson").then(r=>r.json()),
      fetch("Area_B.geojson").then(r=>r.json()),
      fetch("area_C.geojson").then(r=>r.json())
    ]).then(initLayers);

    function initLayers(data){
      let [ramallah, schools, roads, built, settlements, outposts, military, quarries, natural, wells, clinics, hospitals, areaA, areaB, areaC] = data;

      var ramallahLayer=L.geoJSON(ramallah, {
        style:{color:"#000",weight:4,fillOpacity:0},
        onEachFeature:popupAttributes
      }).addTo(map);

      var areaALayer=L.geoJSON(areaA,{style:{color:"#006400",weight:2,fillColor:"#00ff00",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);
      var areaBLayer=L.geoJSON(areaB,{style:{color:"#b8860b",weight:2,fillColor:"#ffff00",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);
      var areaCLayer=L.geoJSON(areaC,{style:{color:"#8b0000",weight:2,fillColor:"#ff0000",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);

      var builtLayer=L.geoJSON(built,{style:{color:"#8B4513",weight:2,fillColor:"#F5F5DC",fillOpacity:0.7},onEachFeature:popupAttributes}).addTo(map);
      var roadsLayer=L.geoJSON(roads,{style:{color:"#4B0082",weight:2},onEachFeature:popupAttributes}).addTo(map);

      var schoolsLayer=L.geoJSON(schools,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-school")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var hospitalsLayer=L.geoJSON(hospitals,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-hospital")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var clinicsLayer=L.geoJSON(clinics,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-clinic")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var wellsLayer=L.geoJSON(wells,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-well")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var quarriesLayer=L.geoJSON(quarries,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-quarry")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var outpostsLayer=L.geoJSON(outposts,{
        pointToLayer:(f,ll)=>L.marker(ll,{icon:icon("icon-outpost")}),
        onEachFeature:popupAttributes
      }).addTo(map);

      var settlementsLayer=L.geoJSON(settlements,{style:{color:"#ff0000",weight:2},onEachFeature:popupAttributes}).addTo(map);
      var militaryLayer=L.geoJSON(military,{style:{color:"#800000",weight:2},onEachFeature:popupAttributes}).addTo(map);
      var naturalLayer=L.geoJSON(natural,{style:{color:"#228b22",fillOpacity:0.5},onEachFeature:popupAttributes}).addTo(map);

      areaALayer.bringToBack();
      areaBLayer.bringToBack();
      areaCLayer.bringToBack();
      ramallahLayer.bringToFront();

      L.control.layers(null,{
        "Ramallah Boundary":ramallahLayer,
        "Area A":areaALayer,
        "Area B":areaBLayer,
        "Area C":areaCLayer,
        "Built-up Areas":builtLayer,
        "Roads":roadsLayer,
        "Schools":schoolsLayer,
        "Hospitals":hospitalsLayer,
        "Clinics":clinicsLayer,
        "Wells":wellsLayer,
        "Quarries":quarriesLayer,
        "Outposts":outpostsLayer,
        "Settlements":settlementsLayer,
        "Military Sites":militaryLayer,
        "Natural Areas":naturalLayer
      },{
        collapsed:false
      }).addTo(map);

      // اقتراح بناء المدارس
      var suggestedSchoolsLayer = L.layerGroup().addTo(map);

      // تحليل عدد المدارس في التجمعات السكانية
      var schoolsInAreaA = getSchoolsInArea(areaA);
      var schoolsInAreaB = getSchoolsInArea(areaB);
      var schoolsInAreaC = getSchoolsInArea(areaC);

      // تحديد التجمعات التي تحتاج إلى مدارس بناءً على العدد
      if (schoolsInAreaA < 5) {
        addSuggestedSchool([31.9000, 35.2030]); // إضافة مدرسة جديدة في موقع محدد
      }

      if (schoolsInAreaB < 5) {
        addSuggestedSchool([31.9100, 35.2100]); // إضافة مدرسة جديدة في موقع محدد
      }

      // إضافة المدارس المقترحة في مناطق لا تقع في Area C
      function addSuggestedSchool(location) {
        // تحقق من الموقع إذا كان يقع خارج Area C
        if (!isInAreaC(location)) {
          L.marker(location, { icon: icon("icon-school") })
            .bindPopup("اقتراح مدرسة جديدة")
            .addTo(suggestedSchoolsLayer);
        }
      }

      function isInAreaC(location) {
        var latLng = L.latLng(location);
        return areaCLayer.getBounds().contains(latLng); // تحقق مما إذا كان الموقع يقع في منطقة C
      }
    }
  </script>
</body>
</html>
