<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Web GIS - Ramallah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    html,body{height:100%;margin:0;}
    #map{height:100%;width:100%;}
    .icon{
      width:10px;height:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      font-weight:bold;
      border-radius:50%;
    }
    /* LANDMARK COLORS */
    .icon-school{background:#1e90ff;}
    .icon-hospital{background:#b22222;}
    .icon-clinic{background:#2e8b57;}
    .icon-well{background:#00ced1;}
    .icon-quarry{background:#696969;}
    .icon-outpost{background:#ff8c00;}
    
    /* LEGEND */
    .legend{
      background:white;
      padding:10px;
      font-size:13px;
      border-radius:6px;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    /* POPUP */
    .popup-table{border-collapse:collapse;width:100%;}
    .popup-table td{border-bottom:1px solid #ddd;padding:4px;font-size:12px;}
    .popup-title{font-weight:bold;margin-bottom:6px;}
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    /* MAP */
    var map = L.map("map").setView([31.9038,35.2034],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      attribution:"&copy; OpenStreetMap"
    }).addTo(map);

    /* POPUP FUNCTION (with Arabic Labels) */
    function popupAttributes(feature, layer){
      if(!feature.properties) return;
      let html='<div class="popup-title">الخصائص</div><table class="popup-table">';
      for(let k in feature.properties){
        html+=`<tr><td><b>${k}</b></td><td>${feature.properties[k]}</td></tr>`;
      }
      html+='</table>';
      layer.bindPopup(html);
    }

    /* ICON */
    function icon(cls){
      return L.divIcon({
        className:"",
        html:`<div class="icon ${cls}"></div>`,
        iconSize:[10,10],
        iconAnchor:[5,5]
      });
    }

    /* LOAD DATA */
    Promise.all([/* same fetches as before */]).then(initLayers);

    /* LAYERS */
    function initLayers(data){
      let [ramallah, schools, roads, built, settlements, outposts, military, quarries, natural, wells, clinics, hospitals, areaA, areaB, areaC] = data;

      /* RAMALLAH BORDER */
      var ramallahLayer=L.geoJSON(ramallah, {
        style:{color:"#000",weight:4,fillOpacity:0},
        onEachFeature:popupAttributes
      }).addTo(map);

      /* AREA LAYERS */
      var areaALayer=L.geoJSON(areaA,{style:{color:"#006400",weight:2,fillColor:"#00ff00",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);
      var areaBLayer=L.geoJSON(areaB,{style:{color:"#b8860b",weight:2,fillColor:"#ffff00",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);
      var areaCLayer=L.geoJSON(areaC,{style:{color:"#8b0000",weight:2,fillColor:"#ff0000",fillOpacity:0.35},onEachFeature:popupAttributes}).addTo(map);

      /* SEARCH FUNCTION (By Area Name) */
      var geocoder = L.Control.Geocoder.nominatim();
      var searchControl = new L.Control.Geocoder({
        geocoder: geocoder
      }).addTo(map);
      
      searchControl.on('markgeocode', function(e) {
        var bbox = e.geocode.bbox;
        var bounds = L.latLngBounds(bbox);
        map.fitBounds(bounds);

        // Add custom popup with area name and number of schools
        var areaName = e.geocode.name;
        var numberOfSchools = getSchoolsInArea(areaName);
        var popupContent = `<b>التجمع السكني: ${areaName}</b><br>عدد المدارس: ${numberOfSchools}`;

        // Check if the area is outside Area C
        var isOutsideAreaC = !L.geoJSON(areaC).getBounds().intersects(bounds); // Check if the area is outside Area C
        if (isOutsideAreaC) {
          popupContent += "<br><span style='color: green;'>الموقع مناسب للبناء</span>";
        } else {
          popupContent += "<br><span style='color: red;'>الموقع داخل منطقة C</span>";
        }

        L.popup().setLatLng(bounds.getCenter()).setContent(popupContent).openOn(map);
      });

      /* Function to get the number of schools in a specific area */
      function getSchoolsInArea(areaName) {
        // Example logic to return a random number of schools
        return Math.floor(Math.random() * 10) + 1;
      }
    }
  </script>
</body>
</html>
