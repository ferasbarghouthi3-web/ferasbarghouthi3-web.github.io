<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ramallah Waste Containers - Updated Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { margin: 0; height: 100%; width: 100%; }
    #map { position: absolute; width: 100%; height: 100%; }
    .info, .legend, .search-box, .density-box, .mode-toggle {
      background: rgba(255,255,255,0.9);
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      border-radius: 5px;
    }
    .legend i {
      width: 18px; height: 18px;
      float: right; margin-left: 8px; opacity: 0.8;
    }
    .search-box input {
      width: 160px;
      padding: 4px;
      border: 1px solid #aaa;
      border-radius: 4px;
    }
    .mode-toggle {
      cursor: pointer;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    const map = L.map("map", { center: [31.9045, 35.2045], zoom: 15 });

    // === Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===
    const baseLayers = {
      "Ø®Ø±ÙŠØ·Ø© Ù„ÙŠÙ„ÙŠØ©": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap & CARTO'
      }),
      "Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø±ÙŠØ©": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }),
    };
    let currentBase = baseLayers["Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø±ÙŠØ©"].addTo(map);

    let zonesLayer, wasteContainersLayer, containerData, zoneDensity = {};

    // ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    $.getJSON("RamallahZones.json", function(RZ) {
      zonesLayer = L.geoJson(RZ, {
        style: {
          color: "black",       // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
          weight: 1,            // Ø³Ù…Ùƒ Ø§Ù„Ø®Ø·
          fillColor: "#d9d9d9", // Ù„ÙˆÙ† Ø³ÙƒÙ†ÙŠ ÙˆØ§Ø¶Ø­
          fillOpacity: 0.4      // Ø´ÙØ§ÙÙŠØ© Ù…Ø¹ØªØ¯Ù„Ø©
        }
      }).addTo(map);

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
      $.getJSON("wasteContainer.json", function(WC) {
        containerData = WC;

        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©
        zonesLayer.eachLayer(function(zoneLayer) {
          const zoneFeature = zoneLayer.feature;
          let count = 0;
          WC.features.forEach(f => {
            const p = turf.point([f.geometry.coordinates[0], f.geometry.coordinates[1]]);
            if (turf.booleanPointInPolygon(p, zoneFeature)) count++;
          });
          zoneDensity[zoneFeature.properties.NAME] = count;
        });

        const counts = Object.values(zoneDensity);
        const max = Math.max(...counts);
        const min = Math.min(...counts);

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„ÙƒØ«Ø§ÙØ©
        function getDensityColor(zoneName) {
          const c = zoneDensity[zoneName] || 0;
          const ratio = (c - min) / (max - min + 0.001);
          if (ratio > 0.66) return "red";
          else if (ratio > 0.33) return "yellow";
          else return "green";
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
        wasteContainersLayer = L.geoJson(WC, {
          pointToLayer: function(feature, latlng) {
            let zoneName = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚";
            zonesLayer.eachLayer(function(z) {
              const p = turf.point([latlng.lng, latlng.lat]);
              if (turf.booleanPointInPolygon(p, z.feature)) zoneName = z.feature.properties.NAME;
            });

            return L.marker(latlng, { icon: trashIcon })
              .bindPopup(`
                <b>ğŸ—‘ï¸ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©:</b> ${feature.properties.TYPE_OF_WA || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}<br>
                <b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${zoneName}<br>
                <b>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${zoneDensity[zoneName] || 0}
              `);
          }
        }).addTo(map);

        // Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
        zonesLayer.eachLayer(function(layer) {
          const zoneName = layer.feature.properties.NAME;
          const count = zoneDensity[zoneName] || 0;
          layer.on('click', function(e) {
            layer.bindPopup(`<b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${zoneName}<br><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª:</b> ${count}`).openPopup();
          });
        });

        // ÙˆØ³ÙŠÙ„Ø© Ø¥ÙŠØ¶Ø§Ø­
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML += "<b>ØªØµÙ†ÙŠÙ Ø§Ù„ÙƒØ«Ø§ÙØ©:</b><br>";
          div.innerHTML += '<i style="background:red"></i> ÙƒØ«Ø§ÙØ© Ø¹Ø§Ù„ÙŠØ©<br>';
          div.innerHTML += '<i style="background:yellow"></i> ÙƒØ«Ø§ÙØ© Ù…ØªÙˆØ³Ø·Ø©<br>';
          div.innerHTML += '<i style="background:green"></i> ÙƒØ«Ø§ÙØ© Ù…Ù†Ø®ÙØ¶Ø©<br>';
          div.innerHTML += '<hr><i style="background:#d9d9d9"></i> Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡<br>';
          div.innerHTML += '<br><img src="https://cdn-icons-png.flaticon.com/512/5028/5028066.png" width="16"> = Ø­Ø§ÙˆÙŠØ© Ù†ÙØ§ÙŠØ§Øª';
          return div;
        };
        legend.addTo(map);

        // Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
        const searchControl = L.control({ position: 'topleft' });
        searchControl.onAdd = function() {
          const div = L.DomUtil.create('div', 'search-box');
          div.innerHTML = `<input id="searchZone" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø·Ù‚Ø©...">`;
          div.firstChild.addEventListener("keyup", function(e) {
            const val = e.target.value.trim();
            zonesLayer.eachLayer(function(layer) {
              const name = layer.feature.properties.NAME;
              if (name.includes(val) && val.length > 0) {
                map.fitBounds(layer.getBounds());
                layer.setStyle({ color: "blue", weight: 3 });
              } else {
                layer.setStyle({ color: "black", weight: 1, fillColor: "#d9d9d9", fillOpacity: 0.4 });
              }
            });
          });
          return div;
        };
        searchControl.addTo(map);

        // Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØ«Ø§ÙØ©
        const densityBox = L.control({ position: 'topright' });
        densityBox.onAdd = function() {
          const div = L.DomUtil.create('div', 'density-box');
          div.innerHTML = `<b>Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒØ«Ø§ÙØ©:</b><br>
            <select id="zoneSelect"></select><br>
            <button id="calcBtn">Ø§Ø­Ø³Ø¨</button>
            <div id="result"></div>`;
          return div;
        };
        densityBox.addTo(map);

        // ØªØ¹Ø¨Ø¦Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
        setTimeout(() => {
          const select = document.getElementById("zoneSelect");
          Object.keys(zoneDensity).forEach(name => {
            const opt = document.createElement("option");
            opt.value = name; opt.textContent = name;
            select.appendChild(opt);
          });

          document.getElementById("calcBtn").onclick = function() {
            const name = select.value;
            const count = zoneDensity[name];
            document.getElementById("result").innerHTML = `<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª:</b> ${count}`;
          };
        }, 500);

        // Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ
        const modeToggle = L.control({ position: 'bottomleft' });
        modeToggle.onAdd = function() {
          const div = L.DomUtil.create('div', 'mode-toggle');
          div.innerHTML = "ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹";
          div.onclick = function() {
            if (map.hasLayer(baseLayers["Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø±ÙŠØ©"])) {
              map.removeLayer(baseLayers["Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø±ÙŠØ©"]);
              baseLayers["Ø®Ø±ÙŠØ·Ø© Ù„ÙŠÙ„ÙŠØ©"].addTo(map);
            } else {
              map.removeLayer(baseLayers["Ø®Ø±ÙŠØ·Ø© Ù„ÙŠÙ„ÙŠØ©"]);
              baseLayers["Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø±ÙŠØ©"].addTo(map);
            }
          };
          return div;
        };
        modeToggle.addTo(map);
      });
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø§ÙˆØ³
    const info = L.control({ position: 'bottomleft' });
    info.onAdd = function() {
      this._div = L.DomUtil.create('div', 'info');
      this.update();
      return this._div;
    };
    info.update = function(latlng) {
      this._div.innerHTML = latlng
        ? `<b>Lat:</b> ${latlng.lat.toFixed(5)} , <b>Lng:</b> ${latlng.lng.toFixed(5)}`
        : "Ø­Ø±Ù‘Ùƒ Ø§Ù„Ù…Ø§ÙˆØ³ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
    };
    info.addTo(map);
    map.on('mousemove', function(e) { info.update(e.latlng); });

    L.control.scale({ metric: true, imperial: false }).addTo(map);
  </script>
</body>
</html>

