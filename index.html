<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ School DSS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body{margin:0;font-family:Arial}
#map{height:100vh}
.header{
 position:absolute;top:0;left:0;right:0;
 background:#1e3d59;color:white;
 padding:10px;z-index:1000;text-align:center
}
.dashboard{
 position:absolute;bottom:20px;right:20px;
 background:white;padding:10px;z-index:1000;font-size:13px
}
</style>
</head>

<body>

<div class="header">
<h3>DSS Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<div class="dashboard">
<b>ğŸ“Š Dashboard</b><br>
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª: <span id="tTotal">0</span><br>
ØªØ¬Ù…Ø¹Ø§Øª ØªØ¹Ø§Ù†ÙŠ Ù…Ù† Ù†Ù‚Øµ: <span id="tDef">0</span><br>
Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©: <span id="tSites">0</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
const map = L.map("map").setView([31.9,35.2],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= LOAD DATA =================
Promise.all([
 fetch("Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª.json").then(r=>r.json()),
 fetch("schools.json").then(r=>r.json()),
 fetch("roods.json").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json()),
 fetch("Ù…Ø³ØªÙˆØ·Ù†Ø§Øª.geojson").then(r=>r.json()),
 fetch("Ø§Ù„Ø¨Ø¤Ø±_Ø§Ù„Ø§Ø³ØªÙŠØ·Ø§Ù†ÙŠØ©.geojson").then(r=>r.json()),
 fetch("Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹_Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ©.geojson").then(r=>r.json()),
 fetch("Ø§Ù„Ø£ÙˆØ¯ÙŠØ©.geojson").then(r=>r.json()),
 fetch("ÙƒØ³Ø§Ø±Ø§Øª.geojson").then(r=>r.json()),
 fetch("natural.json").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(d){

const [tg,schools,roads,built,sett,outp,mil,wad,qua,nat]=d;

let deficitCount=0, siteCount=0;

// ===== DISPLAY BASE LAYERS =====
[built,sett,outp,mil,wad,qua,nat].forEach(g=>{
 L.geoJSON(g,{style:{fillOpacity:0.3}}).addTo(map);
});

L.geoJSON(roads,{style:{color:"orange"}}).addTo(map);
L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue"})
}).addTo(map);

// ================= MAIN ANALYSIS =================
const tgLayer = L.geoJSON(tg,{
 style:f=>{
  const pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
  const need=Math.ceil(pop/3000);
  const cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
  const diff=need-cnt;
  return {
   color:"black",
   fillColor: diff>0?"red":"green",
   fillOpacity:0.4
  };
 },
 onEachFeature:(f,l)=>{

  const pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
  const need=Math.ceil(pop/3000);
  const cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
  const deficit=cnt<need;

  if(deficit){
   deficitCount++;

   const c=turf.centroid(f);

   const insideBuilt = built.features.some(b=>turf.booleanPointInPolygon(c,b));

   const nearRoad = roads.features.some(r=>{
    const rc=turf.centroid(r);
    return turf.distance(c,rc,{units:"km"})<0.5;
   });

   const farSet = [...sett.features,...outp.features].every(s=>{
    const sc=turf.centroid(s);
    return turf.distance(c,sc,{units:"km"})>0.8;
   });

   const score =
    (insideBuilt?30:0)+
    (nearRoad?30:0)+
    (farSet?40:0);

   L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
    .addTo(map)
    .bindPopup(`<b>Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­</b><br>Score: ${score}`);

   siteCount++;
  }

  l.bindPopup(`
   <b>${f.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
   Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${cnt}<br>
   Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${need}<br>
   Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit?"Ù†Ù‚Øµ":"Ù…ÙƒØªÙÙŠ"}
  `);
 }
}).addTo(map);

// ===== DASHBOARD =====
document.getElementById("tTotal").innerText=tg.features.length;
document.getElementById("tDef").innerText=deficitCount;
document.getElementById("tSites").innerText=siteCount;

map.fitBounds(tgLayer.getBounds());
}
</script>
</body>
</html>
