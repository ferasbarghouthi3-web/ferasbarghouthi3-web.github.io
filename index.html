<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ School Planning DSS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}

.dashboard {
  position:absolute;
  bottom:20px;
  right:20px;
  background:white;
  padding:10px;
  z-index:1000;
  font-size:13px;
}
</style>
</head>

<body>

<div class="header">
<h3>Decision Support System Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<div class="dashboard">
<b>ğŸ“Š Dashboard</b><br>
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª: <span id="tTotal">0</span><br>
ØªØ¬Ù…Ø¹Ø§Øª ØªØ¹Ø§Ù†ÙŠ Ù…Ù† Ù†Ù‚Øµ: <span id="tDef">0</span><br>
Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©: <span id="tSites">0</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9,35.2],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= LOAD DATA =================
Promise.all([
 fetch("ramallah.json").then(r=>r.json()),
 fetch("schools.json").then(r=>r.json()),
 fetch("roods.json").then(r=>r.json()),
 fetch("Build_up.json").then(r=>r.json()),
 fetch("Settlements.geojson").then(r=>r.json()),
 fetch("Outposts.geojson").then(r=>r.json()),
 fetch("Military sites.geojson").then(r=>r.json()),
 fetch("Quarries.geojson").then(r=>r.json()),
 fetch("natural.json").then(r=>r.json()),
 fetch("Wells.geojson").then(r=>r.json()),
 fetch("Clinics.geojson").then(r=>r.json()),
 fetch("Hospitals.geojson").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(d){

let [
 tg, schools, roads, built,
 sett, outp, mil, qua,
 nat, wells, clin, hosp
] = d;

let deficitCount=0, siteCount=0;

// ===== DISPLAY LAYERS =====
L.geoJSON(built,{style:{color:"#999",fillOpacity:0.3}}).addTo(map);
L.geoJSON(roads,{style:{color:"orange"}}).addTo(map);
L.geoJSON(sett,{style:{color:"red",fillOpacity:0.4}}).addTo(map);
L.geoJSON(outp,{style:{color:"darkred"}}).addTo(map);
L.geoJSON(mil,{style:{color:"black"}}).addTo(map);
L.geoJSON(qua,{style:{color:"brown"}}).addTo(map);
L.geoJSON(nat,{style:{color:"green"}}).addTo(map);

[wells,clin,hosp].forEach(g=>{
 L.geoJSON(g,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:4})}).addTo(map);
});

L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue"})
}).addTo(map);

// ===== MAIN ANALYSIS =====
let tgLayer = L.geoJSON(tg,{
 style:f=>{
   let pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
   let need=Math.ceil(pop/3000);
   let cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
   let diff=need-cnt;
   let col= diff>=2?"red": diff==1?"orange":"green";
   return {color:"black",fillOpacity:0.4,fillColor:col};
 },
 onEachFeature:(f,l)=>{
   let pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
   let need=Math.ceil(pop/3000);
   let cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
   let deficit=cnt<need;
   if(deficit) deficitCount++;

   let html=`<b>${f.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
   Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${cnt}<br>
   Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${need}<br>
   Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit?"Ù†Ù‚Øµ":"Ù…ÙƒØªÙÙŠ"}`;

   if(deficit){
     let c=turf.centroid(f);

     let score=70;
     let price=120;

     L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
      .addTo(map)
      .bindPopup(`<b>Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­</b><br>Score: ${score}/100<br>Ø§Ù„Ø³Ø¹Ø±: ${price}$`);

     siteCount++;
     html+=`<hr>Score: ${score}/100<br>Ø§Ù„Ø³Ø¹Ø±: ${price}$`;
   }
   l.bindPopup(html);
 }
}).addTo(map);

// ===== DASHBOARD =====
document.getElementById("tTotal").innerText=tg.features.length;
document.getElementById("tDef").innerText=deficitCount;
document.getElementById("tSites").innerText=siteCount;

map.fitBounds(tgLayer.getBounds());
}
</script>
</body>
</html>
